from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters
import sqlite3

# Ð’Ð°Ñˆ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°
TOKEN = '7650228237:AAFEeIjY8YSEjlhNExxGgiS8t2nz4j7kgEc'
# URL Ð²Ð°ÑˆÐµÐ³Ð¾ WebApp
WEB_APP_URL = 'https://coin-dusky-psi.vercel.app/'

conn = sqlite3.connect('db/neymark.db')
cursor = conn.cursor()


async def send_welcome_message(update: Update, username: str) -> None:
    message = (
        f'Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ, {username}, Ñ‡ÐµÐ¼ Ð¼Ð¾Ð³Ñƒ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»ÐµÐ·ÐµÐ½? '
    )
    await update.message.reply_text(message, parse_mode='HTML')


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    username = update.effective_user.first_name
    await send_welcome_message(update, username)
    keyboard = [
        ['ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð¿Ñ€Ð¾Ñ ðŸ“‹'],
        ['ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ ðŸ‘¤'],
        ['ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð· ðŸŽ'],
        [InlineKeyboardButton("Lets go â˜€ï¸", web_app={"url": WEB_APP_URL})]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard[:-1], resize_keyboard=True)  # ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸
    await update.message.reply_text('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:', reply_markup=reply_markup)
    inline_keyboard = [[InlineKeyboardButton("Lets go â˜€ï¸", web_app={"url": WEB_APP_URL})]]
    inline_reply_markup = InlineKeyboardMarkup(inline_keyboard)

    await update.message.reply_text('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:', reply_markup=inline_reply_markup)


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_message = update.message.text
    usernames = update.effective_user.username
    await update.message.reply_text(user_message)
    if user_message == 'ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð¿Ñ€Ð¾Ñ ðŸ“‹':
        username2 = update.effective_user.username
        cursor.execute(f'SELECT username1 FROM neymark WHERE username1 = {username2}')
        data = cursor.fetchone()
        if data is None:
            FIO = ''
            city = ''
            await update.message.reply_text(f'Ð’Ð¸Ð¶Ñƒ Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð½Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ÑÑ')
            await update.message.reply_text(f'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°ÑˆÐµ Ð¤Ð˜Ðž:')
            if user_message != 'ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ð¿Ñ€Ð¾Ñ ðŸ“‹' :
                cursor.execute('INSERT INTO neymark (FIO) VALUES (?)', (user_message))
                conn.commit()
                FIO = user_message
                await update.message.reply_text(f'Ð’ ÐºÐ°ÐºÐ¾Ð¼ Ð³Ð¾Ñ€Ð¾Ð´Ðµ Ð²Ñ‹ Ð¶Ð¸Ð²Ñ‘Ñ‚Ðµ:')
                if user_message != FIO:
                    cursor.execute('INSERT INTO neymark (city, username1) VALUES (?)', (user_message, usernames))
                    conn.commit()
                    await update.message.reply_text(f'Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾')
            else:
                await update.message.reply_text(f'{usernames}, ÑÐµÐ¹Ñ‡Ð°Ñ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð¾Ð¿Ñ€Ð¾Ñ')

    if user_message == 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ ðŸ‘¤':
            await update.message.reply_text(f'Ð’Ð¸Ð¶Ñƒ Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð½Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ÑÑ')
            await update.message.reply_text(f'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°ÑˆÐµ Ð¤Ð˜Ðž:')
            FIO = user_message
            if FIO != 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ ðŸ‘¤' and FIO != '':
                FIO = user_message
                await update.message.reply_text(f'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°ÑˆÑƒ Ð´Ð°Ñ‚Ñƒ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ:')
                age = user_message
                if age != 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ ðŸ‘¤' and age != '':
                    age = user_message
                    await update.message.reply_text(f'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ñ€Ð¾Ð´ Ð´ÐµÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸:')
                    do = user_message
                    if do != 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ ðŸ‘¤' and do != '':
                        do = user_message
def main() -> None:
    application = ApplicationBuilder().token(TOKEN).build()
    application.add_handler(CommandHandler('start', start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, button_handler))
    application.run_polling()

if __name__ == '__main__':
    main()
